-- ============================================================================
-- SCRIPT DEFINITIVO: Migración Completa con Nuevas Especialidades PADRE
-- Propósito: Insertar PADRE nuevos + Migrar datos + Actualizar referencias
-- Fecha: 2025-11-26
-- ============================================================================

USE [Tu_Base_De_Datos]
GO

BEGIN TRANSACTION Migracion_Completa

PRINT '╔════════════════════════════════════════════════════════════════╗'
PRINT '║ PASO 0: INSERTAR NUEVAS ESPECIALIDADES PADRE DEL BACKUP       ║'
PRINT '╚════════════════════════════════════════════════════════════════╝'

-- Insertar nuevas especialidades PADRE que no existen en la tabla original
INSERT INTO TipoExamen (IdTipoExamen, Numero, Nombre, EsPadre, Precio)
SELECT IdTipoExamen, Numero, Nombre, 1, 0.00
FROM (
    VALUES 
    ('FC32BF07-8F5F-46F1-8D83-B835C2851944', 9, 'REPETICIONES'),
    ('E90DD2CB-35D0-4306-86DE-4EB35457D618', 59, 'INDICE DE TORG-PAVLOV'),
    ('22D5B906-3799-4F8A-83AB-5D9185140B58', 21, 'PSICOTECNICO'),
    ('8F2212CD-22DB-4545-AC3B-A8B1DF3FA2BF', 26, 'BASQUET'),
    ('3EF76F6D-D9A6-4175-BB9D-405EB8C08FAC', 30, 'APTO BASICO'),
    ('AADF0EE7-D030-49A6-8191-A7C5565C3337', 7, 'CONSULTORIO'),
    ('71522E88-B387-4C46-9A60-CD608F75262C', 99, 'FUERZAS SEGURIDAD'),
    ('11F5757E-7BC6-4032-AE28-34F11C8C8DD9', 8, 'ECOCARDIOGRAMA'),
    ('143D6F35-78FF-449F-AE4F-BFC686B1FFE4', 13, 'HOCKEY'),
    ('2CA014E0-4517-496B-B27D-841527693F83', 22, 'RUGBY'),
    ('483047B4-B38F-4EB8-B99B-5E884F7D33EB', 20, 'EGRESO'),
    ('D6A02B46-FB57-44E1-9469-6315FC8236EF', 1001, 'FUTBOL'),
    ('C9DEB1AB-6137-41A9-8858-9D015FF32EF8', 6, 'LIBRETA DE EMBARQUE'),
    ('C726F5E5-4EDC-41E8-8225-6EDFC39178FB', 40, 'MENORES DE 13'),
    ('B1A9127D-0025-4145-B2B8-743735457163', 11, 'TRAUMATOLOGIA'),
    ('0D6881F5-95E7-4E76-8A7E-F5AFE15AD573', 58, 'LOGOAUDIOMETRIA'),
    ('9E2013D8-B23D-448A-B06C-C3931B8D55AF', 57, 'ESPIROMETRIA'),
    ('5635736E-8087-44FC-88AF-F27C975A476B', 56, 'AUDIOMETRIA'),
    ('679C038F-8435-4629-A599-BDB68F21FF6D', 60, 'CONSULTA CON ESPECIALISTA'),
    ('FFB07939-8490-4B84-B8BD-CDB39E3865E6', 4, 'ERGOMETRIA'),
    ('C272E604-CD67-4911-BA08-3B4F089FD9BF', 15, 'REINGRESO'),
    ('2BB64097-FCA1-4C9B-8741-206351C47EAA', 17, 'BUZO'),
    ('8D99A190-8947-4F9F-929C-2712BB36B68E', 30, 'ESTUDIO COMPLEMENTARIO')
) AS nuevas_especialidades(IdTipoExamen, Numero, Nombre)
WHERE NOT EXISTS (SELECT 1 FROM TipoExamen WHERE IdTipoExamen = nuevas_especialidades.IdTipoExamen)

PRINT '✓ Nuevas especialidades PADRE insertadas'
PRINT ''

-- ============================================================================
PRINT '╔════════════════════════════════════════════════════════════════╗'
PRINT '║ PASO 1: VERIFICAR INTEGRIDAD DE DATOS ANTES DE MIGRAR         ║'
PRINT '╚════════════════════════════════════════════════════════════════╝'

SELECT 
    Nombre,
    COUNT(*) as 'Cantidad de Registros'
FROM TipoExamen
GROUP BY Nombre
HAVING COUNT(*) > 1
ORDER BY COUNT(*) DESC

PRINT ''

-- ============================================================================
PRINT '╔════════════════════════════════════════════════════════════════╗'
PRINT '║ PASO 2: ACTUALIZAR EsPadre A 0 (SUBTIPOS)                     ║'
PRINT '╚════════════════════════════════════════════════════════════════╝'

UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '5A89F848-B153-4D78-B6A6-00F1A5E89E40'  -- REPETICIONES
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '28BAF053-07FF-4A49-90A1-01B61927A819'  -- LEY + AUDIOMETRIA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '2BBECC7F-B5F9-4D54-AEFE-02B73C8686B4'  -- INDICE DE TORG-PAVLOV
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '261CC50A-342E-432C-920F-05B6491383A1'  -- PSICOTECNICO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'F00F40F0-F439-4596-B6CC-08BA2B3B4DD0'  -- PROFESORADO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '1ECFB2DD-F296-4A61-AE4E-08C4DA1AFFCC'  -- BASQUET CAD. Y VET.
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'E1CB5230-8F0B-4919-91D8-0DFFA773210B'  -- APTO BASICO + ERGO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '254110EB-0A50-47D8-89EF-118D163FCE8B'  -- CONSULTORIO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'D0589609-834F-4AD1-BE52-152D8E2A84E0'  -- PSA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'DA977A5A-0474-4372-94B2-1F57E57D160D'  -- HOCKEY
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'AA29D84D-DD65-45CC-A0A0-235613CD5D1B'  -- PBA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'DF6D38CC-7378-48EF-9FF2-24350E0DE698'  -- ECOCARDIOGRAMA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'EBB22F50-6A8D-484A-B5D8-27FE8695BC2F'  -- ESTUDIO COMPLEMENTARIO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'F81484EB-9055-44E8-9457-2E67CF3A0BBE'  -- ESPIROMETRIA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'A6A9AF8D-6BCE-4F74-BB31-3074E1468186'  -- BASQUET PULGUITAS
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '0CD8BCB4-DBAF-4D1D-AE3D-311DC43E21D0'  -- LEY + LUMBAR (P)
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'E28E702D-32BC-44FD-A800-3D316DD88C3C'  -- RUGBY ANUAL
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '7397CF20-6775-4B23-A724-467E25F71132'  -- BOXEO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '50649A7F-1CD9-4B1D-A953-4C081E734109'  -- LEY + LUMBAR (F-P)
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '74831692-89A8-4C88-99BB-4C1B4200872D'  -- EGRESO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '277DD943-146E-40EA-AE5A-4C68D195B2C0'  -- CASINO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'EAF91332-D4B0-40BE-A8AC-550BCE85A3FC'  -- RUGBY M19
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'DB367360-3505-4D29-ADB8-5A4D8CEEA26C'  -- LEY +LUMBAR (F Y P)
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'B9A14538-1380-4E9D-AC5A-5CA49E7E3B63'  -- LIBRETA SANITARIA CASINO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'BCD49CC1-6D84-4E00-A0F8-6D8EDBCF78B3'  -- LIBRETA DE EMBARQUE
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'F7E8B9A3-3CDF-46CC-B115-78FD8AB40087'  -- BASQUET PRE. E INF.
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'C3B4DD78-6B7C-4931-8343-7F3398C48A8F'  -- LEY + COLUMNA PERFIL
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'B61E46CD-269B-4C0D-9A17-83E326659DEB'  -- LOGOAUDIOMETRIA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '59A39C49-13DD-4A3C-BF5B-83FD788D89E6'  -- MENORES DE 13
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'AA3BC3E4-E828-4FCE-9437-846ACD385EED'  -- LEY + LUMBAR (F-P) + AUDIO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '60E94892-6F59-4202-A966-884FD71A5D8B'  -- FUTBOL METRO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '31500C54-5CD5-4456-8F8E-92B210566018'  -- PERIODICO LEY
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '6FBED54E-7EFA-4162-A006-92FDE7DA9071'  -- CONSULTA CON ESPECIALISTA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '48AD474E-FF97-4345-8BED-93219CD06D68'  -- FUTBOL AFA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '19160B7C-6B3B-47E2-8FD0-94EB26129953'  -- TRAUMATOLOGIA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '331DE206-211E-4871-B05D-9A5FF085EEAC'  -- LEY + LUMBAR (P)
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '830ECB95-8076-44C4-A62F-A03A19283879'  -- LEY + LUMBAR (F-P)
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '51E818FA-2FA4-41FA-A33A-A98020DAEE48'  -- RUGBY 1RA VEZ
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'EEBE9644-9FE3-4951-AA41-AC979482F3B5'  -- FUTBOL PARTICULAR
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '2E9186AB-53AA-4D6E-A848-AFF3D1309AEB'  -- SPF CU-GRAL/MAESTRANZA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'A5251C29-29DB-4AE3-9980-BA2CD60A7001'  -- BUZO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'BC0C3AC1-B13F-4F65-9B9B-BF9CAE8279BD'  -- AUDIOMETRIA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '94B823BD-D36A-4E8F-8127-C89F745C746B'  -- BUZO 1A VEZ
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '4EB46C5E-703B-49FD-ACFB-DDDF0A925C49'  -- REINGRESO LABORAL
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'BD8D30EA-D803-415D-874C-E991157AC26E'  -- ERGOMETRIA
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = 'D7BA1440-2F8F-48F8-9039-EB392497FCA7'  -- APTO FISICO
UPDATE TipoExamen SET EsPadre = 0 WHERE IdTipoExamen = '0D99124F-5B7E-4163-8F94-F95B10FFF4EC'  -- PARTICULAR CON ERGO

PRINT '✓ Se actualizaron 45 registros con EsPadre = 0'
PRINT ''

-- ============================================================================
PRINT '╔════════════════════════════════════════════════════════════════╗'
PRINT '║ PASO 3: ACTUALIZAR IdPadre (REFERENCIAS)                      ║'
PRINT '╚════════════════════════════════════════════════════════════════╝'

UPDATE TipoExamen SET IdPadre = 'FC32BF07-8F5F-46F1-8D83-B835C2851944' WHERE IdTipoExamen = '5A89F848-B153-4D78-B6A6-00F1A5E89E40'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = '28BAF053-07FF-4A49-90A1-01B61927A819'
UPDATE TipoExamen SET IdPadre = 'E90DD2CB-35D0-4306-86DE-4EB35457D618' WHERE IdTipoExamen = '2BBECC7F-B5F9-4D54-AEFE-02B73C8686B4'
UPDATE TipoExamen SET IdPadre = '22D5B906-3799-4F8A-83AB-5D9185140B58' WHERE IdTipoExamen = '261CC50A-342E-432C-920F-05B6491383A1'
UPDATE TipoExamen SET IdPadre = 'B48C1479-1578-4003-B073-4B4C5ECBAA05' WHERE IdTipoExamen = 'F00F40F0-F439-4596-B6CC-08BA2B3B4DD0'
UPDATE TipoExamen SET IdPadre = '8F2212CD-22DB-4545-AC3B-A8B1DF3FA2BF' WHERE IdTipoExamen = '1ECFB2DD-F296-4A61-AE4E-08C4DA1AFFCC'
UPDATE TipoExamen SET IdPadre = '3EF76F6D-D9A6-4175-BB9D-405EB8C08FAC' WHERE IdTipoExamen = 'E1CB5230-8F0B-4919-91D8-0DFFA773210B'
UPDATE TipoExamen SET IdPadre = 'AADF0EE7-D030-49A6-8191-A7C5565C3337' WHERE IdTipoExamen = '254110EB-0A50-47D8-89EF-118D163FCE8B'
UPDATE TipoExamen SET IdPadre = '71522E88-B387-4C46-9A60-CD608F75262C' WHERE IdTipoExamen = 'D0589609-834F-4AD1-BE52-152D8E2A84E0'
UPDATE TipoExamen SET IdPadre = '143D6F35-78FF-449F-AE4F-BFC686B1FFE4' WHERE IdTipoExamen = 'DA977A5A-0474-4372-94B2-1F57E57D160D'
UPDATE TipoExamen SET IdPadre = '0273036f-d487-4bc3-960a-a4dbafea0473' WHERE IdTipoExamen = 'AA29D84D-DD65-45CC-A0A0-235613CD5D1B'
UPDATE TipoExamen SET IdPadre = '11F5757E-7BC6-4032-AE28-34F11C8C8DD9' WHERE IdTipoExamen = 'DF6D38CC-7378-48EF-9FF2-24350E0DE698'
UPDATE TipoExamen SET IdPadre = '8D99A190-8947-4F9F-929C-2712BB36B68E' WHERE IdTipoExamen = 'EBB22F50-6A8D-484A-B5D8-27FE8695BC2F'
UPDATE TipoExamen SET IdPadre = '9E2013D8-B23D-448A-B06C-C3931B8D55AF' WHERE IdTipoExamen = 'F81484EB-9055-44E8-9457-2E67CF3A0BBE'
UPDATE TipoExamen SET IdPadre = '8F2212CD-22DB-4545-AC3B-A8B1DF3FA2BF' WHERE IdTipoExamen = 'A6A9AF8D-6BCE-4F74-BB31-3074E1468186'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = '0CD8BCB4-DBAF-4D1D-AE3D-311DC43E21D0'
UPDATE TipoExamen SET IdPadre = '2CA014E0-4517-496B-B27D-841527693F83' WHERE IdTipoExamen = 'E28E702D-32BC-44FD-A800-3D316DD88C3C'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = '7397CF20-6775-4B23-A724-467E25F71132'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = '50649A7F-1CD9-4B1D-A953-4C081E734109'
UPDATE TipoExamen SET IdPadre = '483047B4-B38F-4EB8-B99B-5E884F7D33EB' WHERE IdTipoExamen = '74831692-89A8-4C88-99BB-4C1B4200872D'
UPDATE TipoExamen SET IdPadre = 'a66ef329-d19a-42ce-bb3b-6e0130b31127' WHERE IdTipoExamen = '277DD943-146E-40EA-AE5A-4C68D195B2C0'
UPDATE TipoExamen SET IdPadre = '2CA014E0-4517-496B-B27D-841527693F83' WHERE IdTipoExamen = 'EAF91332-D4B0-40BE-A8AC-550BCE85A3FC'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = 'DB367360-3505-4D29-ADB8-5A4D8CEEA26C'
UPDATE TipoExamen SET IdPadre = 'A66EF329-D19A-42CE-BB3B-6E0130B31127' WHERE IdTipoExamen = 'B9A14538-1380-4E9D-AC5A-5CA49E7E3B63'
UPDATE TipoExamen SET IdPadre = 'C9DEB1AB-6137-41A9-8858-9D015FF32EF8' WHERE IdTipoExamen = 'BCD49CC1-6D84-4E00-A0F8-6D8EDBCF78B3'
UPDATE TipoExamen SET IdPadre = '8F2212CD-22DB-4545-AC3B-A8B1DF3FA2BF' WHERE IdTipoExamen = 'F7E8B9A3-3CDF-46CC-B115-78FD8AB40087'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = 'C3B4DD78-6B7C-4931-8343-7F3398C48A8F'
UPDATE TipoExamen SET IdPadre = '0D6881F5-95E7-4E76-8A7E-F5AFE15AD573' WHERE IdTipoExamen = 'B61E46CD-269B-4C0D-9A17-83E326659DEB'
UPDATE TipoExamen SET IdPadre = 'C726F5E5-4EDC-41E8-8225-6EDFC39178FB' WHERE IdTipoExamen = '59A39C49-13DD-4A3C-BF5B-83FD788D89E6'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = 'AA3BC3E4-E828-4FCE-9437-846ACD385EED'
UPDATE TipoExamen SET IdPadre = 'D6A02B46-FB57-44E1-9469-6315FC8236EF' WHERE IdTipoExamen = '60E94892-6F59-4202-A966-884FD71A5D8B'
UPDATE TipoExamen SET IdPadre = '23443b79-faa6-4775-a191-078c687f7d4c' WHERE IdTipoExamen = '31500C54-5CD5-4456-8F8E-92B210566018'
UPDATE TipoExamen SET IdPadre = '679C038F-8435-4629-A599-BDB68F21FF6D' WHERE IdTipoExamen = '6FBED54E-7EFA-4162-A006-92FDE7DA9071'
UPDATE TipoExamen SET IdPadre = 'D6A02B46-FB57-44E1-9469-6315FC8236EF' WHERE IdTipoExamen = '48AD474E-FF97-4345-8BED-93219CD06D68'
UPDATE TipoExamen SET IdPadre = 'B1A9127D-0025-4145-B2B8-743735457163' WHERE IdTipoExamen = '19160B7C-6B3B-47E2-8FD0-94EB26129953'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = '331DE206-211E-4871-B05D-9A5FF085EEAC'
UPDATE TipoExamen SET IdPadre = 'f5ee2d91-e689-4011-8841-f531be4a9631' WHERE IdTipoExamen = '830ECB95-8076-44C4-A62F-A03A19283879'
UPDATE TipoExamen SET IdPadre = '2CA014E0-4517-496B-B27D-841527693F83' WHERE IdTipoExamen = '51E818FA-2FA4-41FA-A33A-A98020DAEE48'
UPDATE TipoExamen SET IdPadre = 'D6A02B46-FB57-44E1-9469-6315FC8236EF' WHERE IdTipoExamen = 'EEBE9644-9FE3-4951-AA41-AC979482F3B5'
UPDATE TipoExamen SET IdPadre = '71522E88-B387-4C46-9A60-CD608F75262C' WHERE IdTipoExamen = '2E9186AB-53AA-4D6E-A848-AFF3D1309AEB'
UPDATE TipoExamen SET IdPadre = '2BB64097-FCA1-4C9B-8741-206351C47EAA' WHERE IdTipoExamen = 'A5251C29-29DB-4AE3-9980-BA2CD60A7001'
UPDATE TipoExamen SET IdPadre = '5635736E-8087-44FC-88AF-F27C975A476B' WHERE IdTipoExamen = 'BC0C3AC1-B13F-4F65-9B9B-BF9CAE8279BD'
UPDATE TipoExamen SET IdPadre = '2BB64097-FCA1-4C9B-8741-206351C47EAA' WHERE IdTipoExamen = '94B823BD-D36A-4E8F-8127-C89F745C746B'
UPDATE TipoExamen SET IdPadre = 'C272E604-CD67-4911-BA08-3B4F089FD9BF' WHERE IdTipoExamen = '4EB46C5E-703B-49FD-ACFB-DDDF0A925C49'
UPDATE TipoExamen SET IdPadre = 'FFB07939-8490-4B84-B8BD-CDB39E3865E6' WHERE IdTipoExamen = 'BD8D30EA-D803-415D-874C-E991157AC26E'
UPDATE TipoExamen SET IdPadre = '3EF76F6D-D9A6-4175-BB9D-405EB8C08FAC' WHERE IdTipoExamen = 'D7BA1440-2F8F-48F8-9039-EB392497FCA7'
UPDATE TipoExamen SET IdPadre = 'eebe9644-9fe3-4951-aa41-ac979482f3b5' WHERE IdTipoExamen = '0D99124F-5B7E-4163-8F94-F95B10FFF4EC'

PRINT '✓ Se actualizaron 45 referencias de IdPadre'
PRINT ''

-- ============================================================================
PRINT '╔════════════════════════════════════════════════════════════════╗'
PRINT '║ PASO 4: VERIFICAR RESULTADOS                                  ║'
PRINT '╚════════════════════════════════════════════════════════════════╝'

SELECT 
    COUNT(*) as 'Total Registros',
    SUM(CASE WHEN EsPadre = 1 THEN 1 ELSE 0 END) as 'Padres',
    SUM(CASE WHEN EsPadre = 0 THEN 1 ELSE 0 END) as 'Subtipos'
FROM TipoExamen

PRINT ''
PRINT '--- Verificando referencias rotas después de migración ---'
SELECT 
    COUNT(*) as 'Referencias Rotas'
FROM TipoExamen t1
WHERE EsPadre = 0 
  AND IdPadre IS NOT NULL
  AND IdPadre NOT IN (SELECT IdTipoExamen FROM TipoExamen)
  AND IdPadre != '00000000-0000-0000-0000-000000000000'

PRINT ''
PRINT '--- Mostrando estructura jerárquica de FUTBOL ---'
SELECT 
    CASE WHEN EsPadre = 1 THEN '► PADRE' ELSE '  └─ Subtipo' END as Tipo,
    Nombre,
    Numero,
    IdTipoExamen,
    IdPadre
FROM TipoExamen
WHERE Nombre LIKE '%FUTBOL%' OR IdPadre = 'D6A02B46-FB57-44E1-9469-6315FC8236EF'
ORDER BY EsPadre DESC, Nombre

PRINT ''
PRINT '=== MIGRACIÓN COMPLETADA EXITOSAMENTE ==='
PRINT 'Nuevas especialidades PADRE: 23'
PRINT 'Registros actualizados: 45'
PRINT 'Estado: LISTO PARA COMMIT'
PRINT ''

-- ============================================================================
-- INSTRUCCIONES DE CONFIRMACIÓN
-- ============================================================================
PRINT '╔════════════════════════════════════════════════════════════════╗'
PRINT '║ EJECUTAR UNO DE ESTOS COMANDOS:                              ║'
PRINT '║                                                               ║'
PRINT '║  COMMIT    -- Para aplicar los cambios a la BD                ║'
PRINT '║  ROLLBACK  -- Para deshacer todo si hay problemas             ║'
PRINT '╚════════════════════════════════════════════════════════════════╝'
